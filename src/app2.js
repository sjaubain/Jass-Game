var socket=new WebSocket("ws://"+window.location.href.substring(5)),init=!0;socket.onmessage=function(a){var b=JSON.parse(a.data);if(console.log(b),init){init=!1;var c=b.players.down.cards;for(let a of c)deck.push(a);initBoard(),1==b.players.down.teamid&&($("#leftboard").css("background-color","#ffa366"),$("#upboard").css("background-color","#66c2ff"),$("#rightboard").css("background-color","#ffa366"),$("#downboard").css("background-color","#66c2ff"),$("#lpseudo").css("color","#ffdec7"),$("#upseudo").css("color","#b8e2ff"),$("#rpseudo").css("color","#ffdec7"),$("#dpseudo").css("color","#b8e2ff"),$("#shadowcard").css("background-color","#29a9ff"))}updateOtherBoards(b)},Array.prototype.swap=function(a,c){var d=this[a];return this[a]=this[c],this[c]=d,this};var myturn=!1,myturnAtout=!1,turnColor=-1,atoutColor=-1,curAtout=-1,redScore=0,blueScore=0,cardDragEvent={mousedown:!1,capturedX:0,capturedY:0,target:null,index:0,cursorOnMid:!1},cardArgs={w:80,h:120,spacing:0},curAnnonce={suites:{colour:-1,highestCard:-1,majoration:-1},carres:{value:-1},reset:function(){this.suites.colour=this.suites.highestCard=this.suites.majoration=this.carres.value=-1}};function showAnnoncesPopup(){$("#annonces").css("display","block"),$("#controls").attr("disabled",!0),$("#controls").fadeTo("fast",.5)}function hideAnnoncesPopup(){$("#annonces").css("display","none"),$("#controls").attr("disabled",!1),$("#controls").fadeTo("fast",1),focusBtn("suitestype",-1),focusBtn("suitesvalue",-1),focusBtn("suitescouleur",-1),focusBtn("carres",-1),curAnnonce.reset(),document.getElementById("errorLbl").innerHTML=""}function showScores(a,b){$("#scores").css("display","block"),$("#controls").attr("disabled",!0),$("#redScore")[0].innerHTML="+"+a,$("#blueScore")[0].innerHTML="+"+b,$("#controls").fadeTo("fast",.2),setTimeout(()=>{hideScores()},4e3)}function hideScores(){$("#scores").css("display","none"),$("#controls").attr("disabled",!1),$("#controls").fadeTo("fast",1)}function showAtoutsPopup(){focusBtn("atoutcouleurs",-1),curAtout=-1,$("#atouts").css("display","block"),$("#controls").attr("disabled",!0),$("#controls").fadeTo("fast",.5)}function hideAtoutsPopup(){$("#atouts").css("display","none"),$("#controls").attr("disabled",!1),$("#controls").fadeTo("fast",1),document.getElementById("errorLbl3").innerHTML=""}function annoncesError(a){document.getElementById("errorLbl").innerHTML=a,setTimeout(function(){document.getElementById("errorLbl").innerHTML=""},2e3)}function playError(a){document.getElementById("errorLbl2").innerHTML=a,setTimeout(function(){document.getElementById("errorLbl2").innerHTML=""},2e3)}function atoutError(a){document.getElementById("errorLbl3").innerHTML=a,setTimeout(function(){document.getElementById("errorLbl3").innerHTML=""},2e3)}var deck=[],cards=[];function createCard(a,b,c,d,e,f){var g=document.createElement("img");return g.setAttribute("width",b),g.setAttribute("height",c),g.setAttribute("src","./img/card"+a+d),g.setAttribute("class",e),g.setAttribute("cardId",a),g.setAttribute("id",f),g}async function updateOtherBoards(a){var b=a.players.left,c=a.players.up,d=a.players.right,e=a.players.down;myturn=e.isnext,myturnAtout=e.isnextAtout,turnColor=a.turnColor,atoutColor=a.atoutColor;var f=document.getElementById("downboard"),g=document.getElementById("leftboard"),h=document.getElementById("upboard"),j=document.getElementById("rightboard"),k=document.getElementById("centerboard");document.getElementById("dpseudo").innerHTML=e.username,document.getElementById("lpseudo").innerHTML=b.username,document.getElementById("upseudo").innerHTML=c.username,document.getElementById("rpseudo").innerHTML=d.username;drawCardMid(e.lastcard,"dcard",0,"dcardimg"),drawCardMid(b.lastcard,"lcard",270,"lcardimg"),drawCardMid(c.lastcard,"ucard",0,"ucardimg"),drawCardMid(d.lastcard,"rcard",270,"rcardimg"),g.style.transform=b.isnext?"scale(1.05)":"scale(1)",g.style["box-shadow"]=b.isnext?"0 4px 8px 0 rgb(0 0 0 / 50%), 0 6px 20px 0 rgb(0 0 0 / 100%)":"0 4px 8px 0 rgb(0 0 0 / 12%), 0 6px 20px 0 rgb(0 0 0 / 23%)",h.style.transform=c.isnext?"scale(1.05)":"scale(1)",h.style.boxShadow=c.isnext?"0 4px 8px 0 rgb(0 0 0 / 50%), 0 6px 20px 0 rgb(0 0 0 / 100%)":"0 4px 8px 0 rgb(0 0 0 / 12%), 0 6px 20px 0 rgb(0 0 0 / 23%)",j.style.transform=d.isnext?"scale(1.05)":"scale(1)",j.style.boxShadow=d.isnext?"0 4px 8px 0 rgb(0 0 0 / 50%), 0 6px 20px 0 rgb(0 0 0 / 100%)":"0 4px 8px 0 rgb(0 0 0 / 12%), 0 6px 20px 0 rgb(0 0 0 / 23%)",f.style.boxShadow=e.isnext?"0 4px 8px 0 rgb(0 0 0 / 50%), 0 6px 20px 0 rgb(0 0 0 / 100%)":"0 4px 8px 0 rgb(0 0 0 / 12%), 0 6px 20px 0 rgb(0 0 0 / 23%)",g.innerHTML="";for(let c=0;c<b.cards.length;++c){var l=createCard(b.cards[c],.75*cardArgs.w,.75*cardArgs.h,".svg","othercard");l.style.transform="rotate(90deg)",l.style.top=40+.75*cardArgs.h/5*c+"px",l.style.left="30px",g.appendChild(l)}j.innerHTML="";for(let b=0;b<d.cards.length;++b){var l=createCard(d.cards[b],.75*cardArgs.w,.75*cardArgs.h,".svg","othercard");l.style.transform="rotate(90deg)",l.style.top=40+.75*cardArgs.h/5*b+"px",l.style.left="30px",j.appendChild(l)}h.innerHTML="";for(let b=0;b<c.cards.length;++b){var l=createCard(c.cards[b],.75*cardArgs.w,.75*cardArgs.h,".svg","othercard");l.style.left=60+.75*cardArgs.h/3*b+"px",l.style.top="20px",h.appendChild(l)}updateScore(a.teams[0].nbCards,a.teams[0].nbPoints,a.teams[1].nbCards,a.teams[1].nbPoints);let m=0;for(let b in a.players){if(a.players[b].isTurnWinner){k.children[m].style.transform="scale(1.1)",k.children[m].style.boxShadow="0 4px 8px 0 rgb(0 0 0 / 12%), 0 6px 20px 0 rgb(0 0 0 / 23%)";for(let a=0;4>a;++a)k.children[a].style.zIndex=a;k.children[m].style.zIndex="4",await sleep(1200),k.children[m].style.transform="scale(1)",k.children[m].style.boxShadow="",$("#ucardimg").css("transform","translate(60px, 60px)"),$("#rcardimg").css("transform","translate(-40px, 30px) rotate(0deg)"),$("#dcardimg").css("transform","translate(-40px, -70px)"),$("#lcardimg").css("transform","translate(100px, -80px) rotate(0deg)"),await sleep(800);for(let a=0;4>a;++a)k.children[a].children[0].style.transform+=" scale(4)",k.children[a].children[0].style.opacity="0";await sleep(800);for(let a=0;4>a;++a)k.children[a].innerHTML="";break}m++}a.endSet&&(await sleep(1e3),showScores(a.teams[0].nbPoints,a.teams[1].nbPoints))}function sleep(a){return new Promise(b=>setTimeout(b,a))}function drawCardMid(a,b,c,d){if($("#"+b)[0].innerHTML="",$("#"+b).css("background-color","rgb(206 201 201)"),-1!=a){var e=createCard(a,80,120,".svg","card",d);e.style.transform="rotate("+c+"deg)",e.style.transformOrigin="40px 40px",e.style.transition="all 0.4s",$("#"+b)[0].appendChild(e)}}function addCardToBoard(a){var b=createCard(a,cardArgs.w,cardArgs.h,".svg","card","undefined"),c=document.getElementById("downboard");b.addEventListener("mousedown",function(a){cardDragEvent.mousedown=!0,cardDragEvent.capturedX=a.pageX,cardDragEvent.capturedY=a.pageY,cardDragEvent.target=b,cardDragEvent.target.style.transform="scale(1.2)",cardDragEvent.target.style.zIndex="1000";var c=nthCard(a.pageX,a.pageY);cardDragEvent.index=c,$("#shadowcard").css("left",$("#downboard").children()[c].offsetLeft+"px")}),cards.push(b),c.appendChild(b)}function initBoard(){for(let a=0;a<deck.length;++a)addCardToBoard(deck[a])}function updateBoard(){var a=document.getElementById("downboard");a.innerHTML="";for(let b=0;b<cards.length;++b)a.appendChild(cards[b])}function nthCard(a,b){var c=cards.length,d=cardArgs.w+2*cardArgs.spacing;if(400<b-$("#board").offset().top){var e=Math.floor((a-$("#board").offset().left-(80+(840-c*d)/2))/d);return 0>e?0:e>=c?c-1:e}return-1}function focusBtn(a,b){var c=document.getElementById(a),d=0;for(let e of c.children){if(d==b)switch(e.style.border="solid 4px",a){case"suitestype":curAnnonce.suites.majoration=d;break;case"suitescouleur":curAnnonce.suites.colour=d;break;case"suitesvalue":curAnnonce.suites.highestCard=3+d;break;case"carres":curAnnonce.carres.value=4+d;break;case"atoutcouleurs":curAtout=d;break;default:}else e.style.border="";d++}}function chooseAtout(){-1==curAtout?atoutError("Veuillez choisir une couleur ou schieber"):(network.chooseAtout(curAtout),hideAtoutsPopup())}function checkBonus(){let a=curAnnonce.suites.majoration,b=curAnnonce.suites.colour,c=curAnnonce.suites.highestCard,d=curAnnonce.carres.value,e=!0;if(-1!==a)for(let d=0==a?3:4,f=0;0<d;--d,--f)deck.includes(c+f+9*b)||(e=!1);if(!e)return void annoncesError("suite non valide");let f=!0;if(-1!==d)for(let a=0;4>a;++a)deck.includes(d+9*a)||(f=!1);return f?void hideAnnoncesPopup():void annoncesError("carre non valide")}var network={play:function(a){let b={action:"play",userid:document.getElementById("userid").innerHTML,cardid:a};socket.send(JSON.stringify(b))},chooseAtout:function(a){console.log("caca : "+a);let b={action:"choose-atout",userid:document.getElementById("userid").innerHTML,atout:a};socket.send(JSON.stringify(b))}};function haveColor(a){for(let b of cards)if(Math.floor((b.getAttribute("cardid")-1)/9)==a)return!0;return!1}function haveOnlyBour(a){var b=0,c=!1;for(let d of cards)Math.floor((d.getAttribute("cardid")-1)/9)==a&&b++,d.getAttribute("cardid")-1==5+9*a&&(c=!0);return c&&1==b}function cursorOnMid(a,b){var c=$("#centerboard").offset().top,d=$("#centerboard").offset().left,e=$("#centerboard").width(),f=$("#centerboard").height();return 0<a-d&&a-d<e&&0<b-c&&b-c<f}$(document).on("dragstart",function(){return!1});var board=document.getElementById("board"),cboard=document.getElementById("centerboard"),bckgd=document.getElementById("background"),popupAnnonces=document.getElementById("annonces");board.addEventListener("mouseup",function(a){if(cardDragEvent.target&&cardDragEvent.mousedown&&(cardDragEvent.mousedown=!1,cardDragEvent.target.style.transform="translate(0px,0px) scale(1)",cardDragEvent.target.style.zIndex="2",cursorOnMid(a.pageX,a.pageY))){var b=cardDragEvent.target.attributes.cardid.value;if(!myturn)playError("Ce n'est pas votre tour");else if(myturnAtout&&-1==curAtout)playError("Veuiller d'abord choisir un atout");else{var c=Math.floor((b-1)/9);if(-1!=turnColor&&haveColor(turnColor)&&c!=atoutColor&&c!=turnColor&&!haveOnlyBour(atoutColor))playError("Veuillez suivre la couleur");else{network.play(b),cards.splice(cardDragEvent.index,1),document.getElementById("downboard").removeChild(cardDragEvent.target);var d=cards.length,e=0==d?1e4:$("#downboard").children()[0].offsetLeft;$("#shadowcard").css("left",e+"px")}}}}),board.addEventListener("mousemove",function(a){if(cardDragEvent.mousedown){var b=nthCard(a.pageX,a.pageY),c=cardDragEvent.index;if(0<=b&&b<cards.length&&b!=c){var d=cardArgs.w+2*cardArgs.spacing;cardDragEvent.capturedX+=(b-c)*d,cardDragEvent.index=b,cards.swap(c,b),$("#shadowcard").css("left",$("#downboard").children()[b].offsetLeft+"px"),updateBoard()}var e=$("#board").offset().top,f=$("#board").offset().left;if(a.pageX<f||a.pageX>f+1e3||a.pageY<e||a.pageY>e+650)cardDragEvent.mousedown=!1,cardDragEvent.target.style.transform="translate(0px,0px) scale(1)",cardDragEvent.target.style.zIndex="2";else{var g=a.pageX-cardDragEvent.capturedX,h=a.pageY-cardDragEvent.capturedY;cardDragEvent.target.style.transform="translate("+g+"px,"+h+"px) scale(1.2)"}}});var drawingSurfaceImageData,cnvs=document.getElementById("canvas"),ctx=cnvs.getContext("2d");function saveDrawingSurface(){drawingSurfaceImageData=ctx.getImageData(0,0,160,120)}function restoreDrawingSurface(){ctx.putImageData(drawingSurfaceImageData,0,0)}function drawPlayerIcon(a,b,c){ctx.fillStyle=c,ctx.beginPath(),ctx.arc(a,b,7,0,2*Math.PI),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.arc(a,b+20,12,0,Math.PI,1),ctx.fill()}function initCanvas(){drawPlayerIcon(40,33,"#fdb98c"),drawPlayerIcon(50,33,"#ff8f45"),drawPlayerIcon(40,73,"#9ed8ff"),drawPlayerIcon(50,73,"#41b3ff"),ctx.lineWidth=.2,ctx.fillStyle="#fff";for(let a=0;3>a;++a)ctx.beginPath(),ctx.rect(72+2*a,5+a,10,14),ctx.fill(),ctx.stroke();ctx.lineWidth=.5;for(let a=0;4>a;++a)ctx.beginPath(),ctx.moveTo(110+3*a,9),ctx.lineTo(110+3*a,20),ctx.stroke();ctx.beginPath(),ctx.moveTo(121,9),ctx.lineTo(107,20),ctx.stroke(),saveDrawingSurface()}function updateScore(a,b,c,d){restoreDrawingSurface(),ctx.font="14px Verdana",ctx.fillStyle="#ff8f45",ctx.fillText(a,76,47),ctx.fillText(b,106,47),ctx.fillStyle="#41b3ff",ctx.fillText(c,76,87),ctx.fillText(d,106,87)}hideAnnoncesPopup(),hideAtoutsPopup(),hideScores(),initCanvas();